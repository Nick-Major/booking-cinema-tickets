// @ts-nocheck

// –ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞–º–∏
import { openModal, closeModal } from '../core/modals.js';

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
let timelineHandlersInitialized = false;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
async function loadScheduleInfo(hallId, date) {
    try {
        const response = await fetch(`/admin/halls/${hallId}/schedule-info?date=${date}`);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
        const data = await response.json();
        return data.success ? data : null;
    } catch (error) {
        console.error('Error loading schedule info:', error);
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function updateScheduleHint() {
    const hallSelect = document.getElementById('cinema_hall_id');
    const dateInput = document.getElementById('session_date');
    const scheduleHint = document.getElementById('scheduleHint');
    const allowedTimeRange = document.getElementById('allowedTimeRange');

    if (!hallSelect || !dateInput || !scheduleHint || !allowedTimeRange) {
        console.log('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }

    const hallId = hallSelect.value;
    const date = dateInput.value;

    if (!hallId || !date) {
        scheduleHint.style.display = 'none';
        return;
    }

    loadScheduleInfo(hallId, date).then(data => {
        if (data && data.schedule) {
            // –§–û–†–ú–ê–¢–ò–†–£–ï–ú –í–†–ï–ú–Ø –ë–ï–ó –°–ï–ö–£–ù–î
            const formatTime = (timeString) => timeString.substring(0, 5);
            const startTime = formatTime(data.schedule.start_time);
            const endTime = formatTime(data.schedule.end_time);
            
            let timeRange = `${startTime} - ${endTime}`;
            if (data.schedule.overnight) {
                timeRange += ' (–Ω–æ—á–Ω–æ–π —Ä–µ–∂–∏–º)';
            }
            allowedTimeRange.textContent = timeRange;
            scheduleHint.style.display = 'block';
        } else {
            scheduleHint.style.display = 'none';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞
export function openDeleteSessionModal(sessionId, movieTitle, hallName, sessionTime) {
    console.log('üéØ openDeleteSessionModal –≤—ã–∑–≤–∞–Ω–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', {
        sessionId, 
        movieTitle, 
        hallName, 
        sessionTime
    });
    
    // –ó–ê–ö–†–´–í–ê–ï–ú –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º —É–¥–∞–ª–µ–Ω–∏—è
    closeModal('editSessionModal');
    console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.getElementById('sessionIdToDelete').value = sessionId;
    document.getElementById('sessionMovieNameToDelete').textContent = movieTitle;
    document.getElementById('sessionHallNameToDelete').textContent = hallName;
    document.getElementById('sessionTimeToDelete').textContent = sessionTime;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è
    openModal('deleteSessionModal');
    console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ');
    
    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
    setTimeout(() => {
        const modal = document.getElementById('deleteSessionModal');
        if (modal) {
            const computedStyle = window.getComputedStyle(modal);
            console.log('üîç –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è:', {
                display: computedStyle.display,
                zIndex: computedStyle.zIndex,
                opacity: computedStyle.opacity,
                visibility: computedStyle.visibility
            });
        }
    }, 100);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞
async function deleteMovieSession(sessionId) {
    try {
        const response = await fetch(`/admin/sessions/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            if (window.notifications) {
                window.notifications.show('–°–µ–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
            }
            closeModal('deleteSessionModal');
            closeModal('editSessionModal');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞');
        }
    } catch (error) {
        console.error('Error deleting session:', error);
        if (window.notifications) {
            window.notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞: ' + error.message, 'error');
        }
    }
}

// –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò - –£–õ–£–ß–®–ï–ù–ù–ê–Ø
export function initSessionFormHandlers() {
    console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ñ–æ—Ä–º—ã —Å–µ–∞–Ω—Å–∞...');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.querySelectorAll('[data-open-modal="addSessionModal"]').forEach(button => {
        button.addEventListener('click', function(e) {
            console.log('üéØ –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∞–Ω—Å" –Ω–∞–∂–∞—Ç–∞');
            openModal('addSessionModal');
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            setTimeout(updateScheduleHint, 100);
        });
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
    const hallSelect = document.getElementById('cinema_hall_id');
    const dateInput = document.getElementById('session_date');

    if (hallSelect) {
        hallSelect.addEventListener('change', updateScheduleHint);
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }
    if (dateInput) {
        dateInput.addEventListener('change', updateScheduleHint);
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞
    const addSessionForm = document.getElementById('addSessionForm');
    if (addSessionForm) {
        console.log('‚úÖ –§–æ—Ä–º–∞ addSessionForm –Ω–∞–π–¥–µ–Ω–∞');
        
        addSessionForm.addEventListener('submit', async function(e) {
            console.log('üéØ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞');
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';

                const response = await fetch("/admin/sessions", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    }
                });
                
                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ –°–µ–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    closeModal('addSessionModal');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    if (window.notifications) {
                        window.notifications.show(result.message, 'success');
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    this.reset();
                    
                    // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–†–ê–ù–ò–¶–£ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ–∞–Ω—Å–∞
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } else {
                    console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞:', result.message);
                    if (window.notifications) {
                        window.notifications.show(result.message, 'error');
                    }
                }
            } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                if (window.notifications) {
                    window.notifications.show('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞', 'error');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    } else {
        console.log('‚ùå –§–æ—Ä–º–∞ addSessionForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∞–Ω—Å–∞
    const editSessionForm = document.getElementById('editSessionForm');
    if (editSessionForm) {
        console.log('‚úÖ –§–æ—Ä–º–∞ editSessionForm –Ω–∞–π–¥–µ–Ω–∞');
        editSessionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await updateSession(this);
        });
    } else {
        console.log('‚ùå –§–æ—Ä–º–∞ editSessionForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞
    const deleteSessionForm = document.getElementById('deleteSessionForm');
    if (deleteSessionForm) {
        console.log('‚úÖ –§–æ—Ä–º–∞ deleteSessionForm –Ω–∞–π–¥–µ–Ω–∞');
        deleteSessionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üéØ –§–æ—Ä–º–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            const sessionId = document.getElementById('sessionIdToDelete').value;
            console.log('üéØ ID —Å–µ–∞–Ω—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', sessionId);
            await deleteMovieSession(sessionId);
        });
    } else {
        console.log('‚ùå –§–æ—Ä–º–∞ deleteSessionForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø
export function openAddSessionModal(hallId, date) {
    console.log('üéØ –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–µ–∞–Ω—Å–∞ –¥–ª—è –∑–∞–ª–∞:', { hallId, date });
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ç–∞–π–º–ª–∞–π–Ω–∞
    const hallSelect = document.getElementById('cinema_hall_id');
    if (hallSelect && hallId) {
        hallSelect.value = hallId;
        console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞–ª:', hallId);
    }
    
    const dateInput = document.getElementById('session_date');
    if (dateInput && date) {
        dateInput.value = date;
        console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞:', date);
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    openModal('addSessionModal');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ - –í–ê–ñ–ù–û: –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    setTimeout(() => {
        updateScheduleHint();
        console.log('‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    }, 100);
}

// –ù–û–í–ê–Ø –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø changeTimelineDate
export async function changeTimelineDate(date) {
    console.log('üìÖ –°–º–µ–Ω–∞ –¥–∞—Ç—ã —Ç–∞–π–º–ª–∞–π–Ω–∞ (AJAX):', date);
    
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showTimelineLoading();
        
        console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞...');
        
        const response = await fetch(`/admin/sessions-timeline/load?date=${date}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        });
        
        console.log('üì® –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const html = await response.text();
        console.log('‚úÖ HTML –ø–æ–ª—É—á–µ–Ω, –¥–ª–∏–Ω–∞:', html.length);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        const container = document.getElementById('sessionsTimelineWrapper');
        if (container) {
            container.innerHTML = html;
            hideTimelineLoading();
            
            // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM, –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            reinitializeTimelineHandlers();
            
            console.log('‚úÖ –¢–∞–π–º–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏');
            
            if (window.notifications) {
                window.notifications.show('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            }
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∞–π–º–ª–∞–π–Ω–∞:', error);
        hideTimelineLoading();
        
        // Fallback: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
        console.log('üîÑ Fallback: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
        window.location.href = `/admin/dashboard?date=${date}`;
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API —Å–µ–∞–Ω—Å–æ–≤
export async function fetchSessionsByHall(hallId, date = null) {
    try {
        let url = `/admin/sessions/hall/${hallId}`;
        if (date) {
            url += `?date=${date}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∞–Ω—Å–æ–≤');
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching sessions:', error);
        throw error;
    }
}

export async function toggleSessionActual(sessionId) {
    try {
        const response = await fetch(`/admin/sessions/${sessionId}/toggle-actual`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error toggling session:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∞–Ω—Å–∞ - –ü–ï–†–ï–ü–ò–°–ê–ù–ù–ê–Ø –ù–ê–î–ï–ñ–ù–ê–Ø –í–ï–†–°–ò–Ø
export function openEditSessionModal(sessionId) {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π:');
    const movieSelect = document.getElementById('edit_movie_id');
    if (movieSelect) {
        console.log('  - movieSelect event listeners:', {
            change: movieSelect._events?.change || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            input: movieSelect._events?.input || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
        });
    }
    
    // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –ø–æ—Ç–æ–º –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    openModal('editSessionModal');
    
    // –ñ–¥–µ–º –ø–æ–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä–æ–µ—Ç—Å—è
    setTimeout(() => {
        fetch(`/admin/sessions/${sessionId}/edit`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(session => {
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–µ–∞–Ω—Å–∞ –ø–æ–ª—É—á–µ–Ω—ã:', session);
                fillEditSessionForm(session);
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–∞:', error);
                if (window.notifications) {
                    window.notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–∞: ' + error.message, 'error');
                }
                closeModal('editSessionModal');
            });
    }, 100);
}

// –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function fillEditSessionForm(session) {
    console.log('üîÑ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∞–Ω—Å–∞...');

    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç ID –ø–µ—Ä–µ–¥ —Ä–∞–±–æ—Ç–æ–π —Å —Ñ–æ—Ä–º–æ–π
    fixIdConflict();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
    const getElement = (id) => {
        return document.getElementById(id);
    };

    // 1. –ó–ê–ü–û–õ–ù–Ø–ï–ú –°–ö–†–´–¢–´–ï –ü–û–õ–Ø
    const sessionIdInput = getElement('edit_session_id');
    if (sessionIdInput) {
        sessionIdInput.value = session.id;
    }
    
    // 2. –ó–ê–ü–û–õ–ù–Ø–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ï –ü–û–õ–Ø
    const currentMovieSpan = getElement('edit_current_movie');
    const currentHallSpan = getElement('edit_current_hall');
    const currentTimeSpan = getElement('edit_current_time');
    
    if (currentMovieSpan) {
        currentMovieSpan.textContent = session.movie?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª—å–º';
    }
    if (currentHallSpan) {
        currentHallSpan.textContent = session.cinema_hall?.hall_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∑–∞–ª';
    }
    if (currentTimeSpan) {
        const sessionStart = new Date(session.session_start);
        const displayTime = sessionStart.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        });
        const displayDate = sessionStart.toLocaleDateString('ru-RU');
        currentTimeSpan.textContent = `${displayDate} ${displayTime}`;
    }
    
    // 3. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –§–ò–õ–¨–ú - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å–º–∞:', session.movie_id, session.movie?.title);

    // –ù–∞—Ö–æ–¥–∏–º select –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∞–Ω—Å–∞
    const sessionForm = document.getElementById('editSessionForm');
    const movieSelect = sessionForm ? sessionForm.querySelector('select[name="movie_id"]') : document.getElementById('edit_movie_id');

    if (movieSelect && movieSelect.tagName === 'SELECT') {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω movieSelect (SELECT —ç–ª–µ–º–µ–Ω—Ç)');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        movieSelect.value = session.movie_id.toString();
        console.log('‚úÖ –§–∏–ª—å–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', movieSelect.value);
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º selectedIndex
        if (movieSelect.options) {
            for (let i = 0; i < movieSelect.options.length; i++) {
                if (movieSelect.options[i].value === session.movie_id.toString()) {
                    movieSelect.selectedIndex = i;
                    console.log('‚úÖ selectedIndex —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', i);
                    break;
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        setTimeout(() => {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–∏–ª—å–º–∞:');
            console.log('  - value:', movieSelect.value);
            console.log('  - selectedIndex:', movieSelect.selectedIndex);
            console.log('  - selected text:', movieSelect.options[movieSelect.selectedIndex]?.text);
        }, 50);
        
    } else {
        console.error('‚ùå movieSelect –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è SELECT —ç–ª–µ–º–µ–Ω—Ç–æ–º:', movieSelect);
    }
    
    // 4. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ó–ê–õ
    console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ª–∞:', session.cinema_hall_id, session.cinema_hall?.hall_name);
    const hallSelect = getElement('edit_cinema_hall_id');
    if (hallSelect) {
        hallSelect.value = session.cinema_hall_id.toString();
        console.log('‚úÖ –ó–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', hallSelect.value);
    }
    
    // 5. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –î–ê–¢–£ –ò –í–†–ï–ú–Ø
    const dateInput = getElement('edit_session_date');
    const timeInput = getElement('edit_session_time');
    if (dateInput && timeInput) {
        const sessionDate = new Date(session.session_start);
        
        const year = sessionDate.getFullYear();
        const month = String(sessionDate.getMonth() + 1).padStart(2, '0');
        const day = String(sessionDate.getDate()).padStart(2, '0');
        const hours = String(sessionDate.getHours()).padStart(2, '0');
        const minutes = String(sessionDate.getMinutes()).padStart(2, '0');
        
        const formattedDate = `${year}-${month}-${day}`;
        const formattedTime = `${hours}:${minutes}`;
        
        dateInput.value = formattedDate;
        timeInput.value = formattedTime;
        
        console.log('üìÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:', {
            original: session.session_start,
            dateInput: formattedDate,
            timeInput: formattedTime,
            local: sessionDate.toLocaleString('ru-RU')
        });
    }
    
    // 6. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –°–¢–ê–¢–£–° –ê–ö–¢–ò–í–ù–û–°–¢–ò
    const isActualCheckbox = getElement('edit_is_actual');
    if (isActualCheckbox) {
        isActualCheckbox.checked = Boolean(session.is_actual);
        console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', session.is_actual);
    }
    
    // 7. –û–ë–ù–û–í–õ–Ø–ï–ú ACTION –§–û–†–ú–´
    const form = getElement('editSessionForm');
    if (form) {
        form.action = `/admin/sessions/${session.id}`;
    }
    
    // 8. –§–ò–ù–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    setTimeout(() => {
        console.log('üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:');
        
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–Ω–æ–≤–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        const movieSelectFinal = getElement('edit_movie_id');
        const hallSelectFinal = getElement('edit_cinema_hall_id');
        const dateInputFinal = getElement('edit_session_date');
        const timeInputFinal = getElement('edit_session_time');
        const isActualCheckboxFinal = getElement('edit_is_actual');
        
        console.log('  - movieSelect.value:', movieSelectFinal?.value);
        console.log('  - movieSelect.selectedIndex:', movieSelectFinal?.selectedIndex);
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ selected option text
        if (movieSelectFinal && movieSelectFinal.options && movieSelectFinal.selectedIndex !== undefined && movieSelectFinal.selectedIndex !== -1) {
            const selectedOption = movieSelectFinal.options[movieSelectFinal.selectedIndex];
            console.log('  - selected option text:', selectedOption?.text);
        } else {
            console.log('  - selected option text: –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ');
        }
        
        console.log('  - hallSelect.value:', hallSelectFinal?.value);
        console.log('  - dateInput.value:', dateInputFinal?.value);
        console.log('  - timeInput.value:', timeInputFinal?.value);
        console.log('  - isActualCheckbox.checked:', isActualCheckboxFinal?.checked);
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç
        console.log('üëÄ –í–ò–ó–£–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:');
        if (movieSelectFinal) {
            console.log('  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å–º:', movieSelectFinal.value === '3' ? '–î–ê' : '–ù–ï–¢');
        }
    }, 100);

    // 9. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DOM
    setTimeout(() => {
        diagnoseDOM();
    }, 150);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ID
function fixIdConflict() {
    console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ID...');
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å id="edit_movie_id"
    const elementsWithSameId = document.querySelectorAll('#edit_movie_id');
    
    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å id="edit_movie_id": ${elementsWithSameId.length}`);
    
    elementsWithSameId.forEach((element, index) => {
        console.log(`  [${index}] tag: ${element.tagName}, type: ${element.type}, in form: ${element.form?.id}`);
        
        // –ï—Å–ª–∏ —ç—Ç–æ hidden input –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–ª—å–º–∞ - –º–µ–Ω—è–µ–º ID
        if (element.tagName === 'INPUT' && element.type === 'hidden' && element.form?.id === 'editMovieForm') {
            console.log('üîÑ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º ID hidden input –≤ editMovieForm...');
            element.id = 'edit_movie_form_id';
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const remainingElements = document.querySelectorAll('#edit_movie_id');
    console.log(`‚úÖ –û—Å—Ç–∞–ª–æ—Å—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å id="edit_movie_id": ${remainingElements.length}`);
    
    remainingElements.forEach((element, index) => {
        console.log(`  [${index}] tag: ${element.tagName}, in form: ${element.form?.id}`);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ DOM —Å–æ—Å—Ç–æ—è–Ω–∏—è
function diagnoseDOM() {
    console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DOM:');
    
    const movieSelect = document.getElementById('edit_movie_id');
    const hallSelect = document.getElementById('edit_cinema_hall_id');
    
    if (!movieSelect) {
        console.error('‚ùå movieSelect –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
        return;
    }
    
    if (!hallSelect) {
        console.error('‚ùå hallSelect –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
        return;
    }
    
    console.log('=== MOVIE SELECT –î–ï–¢–ê–õ–ò ===');
    console.log('  - exists:', !!movieSelect);
    console.log('  - in DOM:', document.body.contains(movieSelect));
    console.log('  - parent:', movieSelect.parentNode?.tagName);
    console.log('  - options count:', movieSelect.options?.length);
    console.log('  - value:', movieSelect.value);
    console.log('  - selectedIndex:', movieSelect.selectedIndex);
    
    console.log('=== HALL SELECT –î–ï–¢–ê–õ–ò ===');
    console.log('  - exists:', !!hallSelect);
    console.log('  - in DOM:', document.body.contains(hallSelect));
    console.log('  - parent:', hallSelect.parentNode?.tagName);
    console.log('  - options count:', hallSelect.options?.length);
    console.log('  - value:', hallSelect.value);
    console.log('  - selectedIndex:', hallSelect.selectedIndex);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
    console.log('=== –†–û–î–ò–¢–ï–õ–¨–°–ö–ê–Ø –ò–ï–†–ê–†–•–ò–Ø ===');
    console.log('  - movieSelect parent chain:', getParentChain(movieSelect));
    console.log('  - hallSelect parent chain:', getParentChain(hallSelect));
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
function getParentChain(element) {
    const chain = [];
    let current = element;
    while (current && current !== document.body) {
        chain.push(current.tagName + (current.id ? `#${current.id}` : ''));
        current = current.parentNode;
    }
    return chain.join(' > ');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–≤—É—Ö select —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function compareSelects() {
    const movieSelect = document.getElementById('edit_movie_id');
    const hallSelect = document.getElementById('edit_cinema_hall_id');
    
    console.log('üîç –î–ï–¢–ê–õ–¨–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï SELECT –≠–õ–ï–ú–ï–ù–¢–û–í:');
    
    if (!movieSelect || !hallSelect) {
        console.error('‚ùå –û–¥–∏–Ω –∏–∑ select —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    console.log('=== MOVIE SELECT ===');
    console.log('  - value:', movieSelect.value);
    console.log('  - selectedIndex:', movieSelect.selectedIndex);
    console.log('  - options length:', movieSelect.options.length);
    console.log('  - disabled:', movieSelect.disabled);
    console.log('  - style.display:', movieSelect.style.display);
    console.log('  - classList:', movieSelect.classList);
    
    console.log('=== HALL SELECT ===');
    console.log('  - value:', hallSelect.value);
    console.log('  - selectedIndex:', hallSelect.selectedIndex);
    console.log('  - options length:', hallSelect.options.length);
    console.log('  - disabled:', hallSelect.disabled);
    console.log('  - style.display:', hallSelect.style.display);
    console.log('  - classList:', hallSelect.classList);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–ø—Ü–∏–∏
    console.log('=== MOVIE OPTIONS ===');
    for (let i = 0; i < movieSelect.options.length; i++) {
        const option = movieSelect.options[i];
        console.log(`  [${i}] value="${option.value}", text="${option.text}", selected=${option.selected}`);
    }
    
    console.log('=== HALL OPTIONS ===');
    for (let i = 0; i < hallSelect.options.length; i++) {
        const option = hallSelect.options[i];
        console.log(`  [${i}] value="${option.value}", text="${option.text}", selected=${option.selected}`);
    }
}

// –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ select
// function setSelectValue(selectElement, value) {
//     if (!selectElement) return false;
    
//     console.log(`üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ select –∑–Ω–∞—á–µ–Ω–∏—è: ${value}`, {
//         element: selectElement,
//         optionsCount: selectElement.options.length,
//         currentValue: selectElement.value
//     });
    
//     // –°–ø–æ—Å–æ–± 1: –ü—Ä—è–º–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è
//     selectElement.value = value;
    
//     // –°–ø–æ—Å–æ–± 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ selectedIndex
//     let found = false;
//     for (let i = 0; i < selectElement.options.length; i++) {
//         const option = selectElement.options[i];
//         if (option.value === value.toString()) {
//             selectElement.selectedIndex = i;
//             found = true;
//             console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è: index=${i}, value=${option.value}, text=${option.text}`);
//             break;
//         }
//     }
    
//     // –°–ø–æ—Å–æ–± 3: –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–µ
//     if (!found) {
//         selectElement.value = value;
//     }
    
//     // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏—è
//     selectElement.dispatchEvent(new Event('change', { bubbles: true }));
//     selectElement.dispatchEvent(new Event('input', { bubbles: true }));
    
//     // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
//     setTimeout(() => {
//         console.log(`üîç –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:`, {
//             value: selectElement.value,
//             selectedIndex: selectElement.selectedIndex,
//             selectedText: selectElement.options[selectElement.selectedIndex]?.text
//         });
//     }, 10);
    
//     return true;
// }

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞
async function updateSession(form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        const formData = new FormData(form);
        formData.append('_method', 'PUT');
        
        // –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–•
        console.log('üîç –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}:`, value);
        }

        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        // –õ–û–ì–ò–†–£–ï–ú –û–¢–í–ï–¢ –°–ï–†–í–ï–†–ê
        console.log('üì® –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        const result = await response.json();
        console.log('üì® –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞:', result);

        if (!response.ok) {
            throw new Error(result.message || `HTTP error! status: ${response.status}`);
        }

        if (result.success) {
            console.log('‚úÖ –°–µ–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
            
            if (window.notifications) {
                window.notifications.show('–°–µ–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            }
            
            closeModal('editSessionModal');
            
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            throw new Error(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞');
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞:', error);
        
        if (window.notifications && typeof window.notifications.show === 'function') {
            window.notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞: ' + error.message, 'error');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ–∞–Ω—Å–∞: ' + error.message);
        }
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// ============================================================================
// –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–ê–ô–ú–õ–ê–ô–ù–ê
// ============================================================================

// –ù–û–í–ê–Ø –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –¢–ê–ô–ú–õ–ê–ô–ù–ê
export function initTimelineHandlers() {
    if (timelineHandlersInitialized) {
        console.log('‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞–π–º–ª–∞–π–Ω–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
        return;
    }
    
    console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ç–∞–π–º–ª–∞–π–Ω–∞...');
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.removeEventListener('click', handleTimelineClick);
    document.removeEventListener('change', handleTimelineChange);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º capture phase
    document.addEventListener('click', handleTimelineClick, true); // capture phase
    document.addEventListener('change', handleTimelineChange, true); // capture phase
    
    timelineHandlersInitialized = true;
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞–π–º–ª–∞–π–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (capture phase)');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function handleTimelineClick(e) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–µ–ª—å –∫–Ω–æ–ø–∫–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const prevBtn = e.target.closest('.timeline-nav-btn[data-action="prev"]');
    const nextBtn = e.target.closest('.timeline-nav-btn[data-action="next"]');
    
    if (prevBtn) {
        console.log('‚¨ÖÔ∏è –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" (capture)');
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const prevDate = prevBtn.getAttribute('data-prev-date');
        console.log('üìÖ –î–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:', prevDate);
        
        // –í—ã–∑—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
        setTimeout(() => changeTimelineDate(prevDate), 0);
        return false;
    }
    
    if (nextBtn) {
        console.log('‚û°Ô∏è –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í–ø–µ—Ä–µ–¥" (capture)');
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const nextDate = nextBtn.getAttribute('data-next-date');
        console.log('üìÖ –î–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:', nextDate);
        
        setTimeout(() => changeTimelineDate(nextDate), 0);
        return false;
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞
function handleTimelineChange(e) {
    if (e.target.classList.contains('timeline-date-input')) {
        console.log('üìÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –≤ input (capture):', e.target.value);
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        setTimeout(() => changeTimelineDate(e.target.value), 0);
        return false;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
function showTimelineLoading() {
    const container = document.getElementById('sessionsTimelineWrapper');
    if (container) {
        container.style.opacity = '0.6';
        container.style.pointerEvents = 'none';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'timeline-loading';
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>';
        loadingDiv.style.position = 'absolute';
        loadingDiv.style.top = '50%';
        loadingDiv.style.left = '50%';
        loadingDiv.style.transform = 'translate(-50%, -50%)';
        loadingDiv.style.background = 'rgba(255,255,255,0.9)';
        loadingDiv.style.padding = '10px 20px';
        loadingDiv.style.borderRadius = '5px';
        loadingDiv.style.zIndex = '1000';
        
        container.style.position = 'relative';
        container.appendChild(loadingDiv);
    }
}

function hideTimelineLoading() {
    const container = document.getElementById('sessionsTimelineWrapper');
    if (container) {
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
        
        const loadingElement = container.querySelector('.timeline-loading');
        if (loadingElement) {
            loadingElement.remove();
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ—Å–ª–µ AJAX-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function reinitializeTimelineHandlers() {
    console.log('üîÑ –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ç–∞–π–º–ª–∞–π–Ω–∞...');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    timelineHandlersInitialized = false;
    
    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    initTimelineHandlers();
    
    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
    if (typeof initSchedules === 'function') {
        initSchedules();
    }
    
    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–µ–∞–Ω—Å–æ–≤
    if (typeof initSessionFormHandlers === 'function') {
        initSessionFormHandlers();
    }
}
